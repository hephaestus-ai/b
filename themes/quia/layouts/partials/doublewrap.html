{{/*
Partial for a two-column text wrap around a central image.
Expects a context (.) with the following parameters:
- LeftImage: URL for the left half of the image.
- RightImage: URL for the right half of theimage.
- LeftContent: Markdown content for the left column.
- RightContent: Markdown content for the right column.
- LeftClass: (Optional) Custom class for the left image div. Default: "doublewrap-left".
- RightClass: (Optional) Custom class for the right image div. Default: "doublewrap-right".
- Width: (Optional) Width of the image halves. Default: "200px".
- Height: (Optional) Height of the image halves. Default: "400px".
*/}}

{{ $left_image := .LeftImage | default "" }}
{{ $right_image := .RightImage | default "" }}
{{ $left_content := .LeftContent | default "" }}
{{ $right_content := .RightContent | default "" }}
{{ $left_class := .LeftClass | default "doublewrap-left" }}
{{ $right_class := .RightClass | default "doublewrap-right" }}
{{ $width := .Width | default "200px" }}
{{ $height := .Height | default "400px" }}

{{ $container_max_width := .ContainerMaxWidth | default "42em" }}
{{ $padding := .Padding | default "0 0.5em" }}
{{ $margin := .Margin | default "0 0 0 0.8em" }}


<script defer>
(function () {
  if (!('ResizeObserver' in window)) return;   // skip on ancient browsers

  const WRAP_SEL  = '.doublewrap-container';
  const IMG_SEL   = 'img.js-float-centre';
  const COL_SEL   = '.left-col, .right-col';
  const PX_TOLERANCE = 20;

  /** centre all floats inside one wrap */
  function centreWrap(wrap) {
    const imgs = wrap.querySelectorAll(IMG_SEL);
    if (!imgs.length) return;

    // tallest column in the pair
    const colHeights = [...wrap.querySelectorAll(COL_SEL)]
                       .map(col => col.offsetHeight);
    const hWrap = Math.max(...colHeights);

    imgs.forEach(img => {
      const hImg  = img.offsetHeight;
      const mNow  = parseFloat(getComputedStyle(img).marginTop) || 0;
      const want  = Math.max(0, (hWrap - hImg) / 2);

      if (Math.abs(want - mNow) > PX_TOLERANCE) {        // jitter guard
        img.style.setProperty('--float-top', `${want}px`);
        img.style.marginTop = 'var(--float-top)';
      }
    });
  }

  /** hook up observers for each wrap once */
  function init(wrap) {
    const ro = new ResizeObserver(() => centreWrap(wrap));
    wrap.querySelectorAll(COL_SEL).forEach(col => ro.observe(col));
    centreWrap(wrap);                         // first run
    addEventListener('resize', () => centreWrap(wrap), { passive: true });
  }

  addEventListener('DOMContentLoaded', () =>
    document.querySelectorAll(WRAP_SEL).forEach(init)
  );
})();
</script>

<style>
  .doublewrap-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    max-width: {{ $container_max_width }};
    padding: {{ $padding }};
    margin: {{ $margin }};
  }

  .doublewrap-container div.left-col,
  .doublewrap-container div.right-col {
    display: flow-root; /* Creates a new block formatting context */
  }

  .doublewrap-container .left-col p,
  .doublewrap-container .right-col p,
  .doublewrap-container .left-col ul,
  .doublewrap-container .right-col ul {
    margin: 0;
    text-align: justify;
  }
  
  .doublewrap-container .left-col ul,
  .doublewrap-container .right-col ul {
      list-style-position: inside;
      padding-left: 1.25rem;
  }

  .{{ $left_class }},
  .{{ $right_class }} {
    width: {{ $width }};
    height: {{ $height }};
    shape-image-threshold: 0.5;
    shape-margin: 1rem;
  }

  .left-col img.js-float-centre,
  .right-col img.js-float-centre {
    margin-top:   var(--float-top,0);
  }


  .{{ $left_class }} {
    float: right;
    shape-outside: url("{{ $left_image }}");
    margin-left: 1.25rem;
  }

  .{{ $right_class }} {
    float: left;
    shape-outside: url("{{ $right_image }}");
    margin-right: 1.25rem;
  }
</style>

<div class="doublewrap-container">
  <div class="left-col">
    {{ with $left_image }}
      <img src="{{ . }}" class="{{ $left_class }} js-float-centre" alt="">
    {{ end }}
    {{ $left_content | markdownify }}
  </div>
  <div class="right-col">
    {{ with $right_image }}
      <img src="{{ . }}" class="{{ $right_class }} js-float-centre" alt="">
    {{ end }}
    {{ $right_content | markdownify }}
  </div>
</div>