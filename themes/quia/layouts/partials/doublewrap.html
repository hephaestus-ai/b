{{/*
Partial for a two-column text wrap around a central image.
Expects a context (.) with the following parameters:
- LeftImage: URL for the left half of the image.
- RightImage: URL for the right half of theimage.
- LeftContent: Markdown content for the left column.
- RightContent: Markdown content for the right column.
- LeftClass: (Optional) Custom class for the left image div. Default: "doublewrap-left".
- RightClass: (Optional) Custom class for the right image div. Default: "doublewrap-right".
- Width: (Optional) Width of the image halves. Default: "200px".
- Height: (Optional) Height of the image halves. Default: "400px".
*/}}

{{ $left_image := .LeftImage | default "" }}
{{ $right_image := .RightImage | default "" }}
{{ $mobile_image := .MobileImage | default ""}}
{{ $left_content := .LeftContent | default "" }}
{{ $right_content := .RightContent | default "" }}
{{ $left_class := .LeftClass | default "doublewrap-left" }}
{{ $right_class := .RightClass | default "doublewrap-right" }}
{{ $width := .Width | default "200px" }}
{{ $height := .Height | default "400px" }}

{{ $container_max_width := .ContainerMaxWidth | default "42em" }}
{{ $padding := .Padding | default "0 0.5em" }}
{{ $margin := .Margin | default "0 0 0 0.8em" }}

{{ $centerCols := .CenterCols | default false}}


<script defer>
(() => {
  if (!('ResizeObserver' in window)) return;

  const WRAP_SEL      = '.doublewrap-container';
  {{ if $centerCols }}
  const IMG_SEL       = 'img.js-float-centre, .right-col-content, .left-col-content';
  {{ else }}
  const IMG_SEL       = 'img.js-float-centre'; 
  {{ end }}
  const COL_SEL       = '.left-col, .right-col';
  const PX_TOLERANCE  = 15;

  const wraps = [];
  let resizeHandlerAttached = false;
  let ro; // single ResizeObserver

  function waitForImages(root = document) {
    const imgs = [...root.querySelectorAll('img')];
    if (!imgs.length) return Promise.resolve();
    return Promise.all(
      imgs.map(img => {
        if (img.complete && img.naturalHeight !== 0) return Promise.resolve();
        return new Promise(res => img.addEventListener('load', res, { once: true }));
      })
    );
  }

  function centreWrap(wrap) {
    const imgs = wrap.querySelectorAll(IMG_SEL);
    if (!imgs.length) return;

    const hWrap = Math.max(
      ...[...wrap.querySelectorAll(COL_SEL)].map(col => col.offsetHeight)
    );

    imgs.forEach(img => {
      const hImg = img.offsetHeight;
      const mNow = parseFloat(getComputedStyle(img).marginTop) || 0;
      const want = Math.max(0, (hWrap - hImg) / 2);
      if (Math.abs(want - mNow) > PX_TOLERANCE) {
        img.style.setProperty('--float-top', `${Math.round(want)}px`);
        img.style.marginTop = 'var(--float-top)';
      }
    });
  }

  function runAll() {
    wraps.forEach(centreWrap);
  }

	function debounce(fn, wait) {
	  let t;
	  let lastW = window.innerWidth;
	  let lastH = window.innerHeight;

	  return (...args) => {
		clearTimeout(t);
		t = setTimeout(() => {
		  const nowW = window.innerWidth;
		  const nowH = window.innerHeight;
		  if (nowW !== lastW || nowH !== lastH) {
			lastW = nowW;
			lastH = nowH;
			fn.apply(null, args);
		  }
		}, wait);
	  };
	}

  async function init() {
    const found = [...document.querySelectorAll(WRAP_SEL)];
    if (!found.length) return;

    wraps.push(...found);

    // Ensure deterministic first measurement
    await waitForImages(document);

    // Initial render after images are known
    runAll();

    // One observer for all columns
    ro = new ResizeObserver(() => {
      // Schedule to end of current task to avoid re-entrancy
      queueMicrotask(runAll);
    });
    wraps.forEach(wrap => {
      wrap.querySelectorAll(COL_SEL).forEach(col => ro.observe(col));
    });

    // One global resize listener (not one per wrap)
    if (!resizeHandlerAttached) {
      window.addEventListener('resize', debounce(runAll, 100), { passive: true });
      resizeHandlerAttached = true;
    }
  }

  // Use window "load" so we never run before assets are available on hard reload
  window.addEventListener('load', init);
})();
</script>




<style>
.right-col-content h1,
.left-col-content h1,
.right-col-content h2,
.left-col-content h2,
.right-col-content h3,
.left-col-content h3,
.right-col-content h4,
.left-col-content h4,
.right-col-content h5,
.left-col-content h5,
.right-col-content h6,
.left-col-content h6
 {
  display: inline-block;
}

  .doublewrap-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    max-width: {{ $container_max_width }};
    padding: {{ $padding }};
    margin: {{ $margin }};
  }
  


  .doublewrap-container div.left-col,
  .doublewrap-container div.right-col {
    display: flow-root; /* Creates a new block formatting context */
  }

  .doublewrap-container .left-col p,
  .doublewrap-container .right-col p,
  .doublewrap-container .left-col ul,
  .doublewrap-container .right-col ul {
    margin: 0 1em;
    text-align: justify;
	color: var(--fg-muted-bright);
	font-family: 'spectral';
  }
  
  .doublewrap-container .left-col p,
  .doublewrap-container .left-col ul {
    text-indent: 1em;
  }
  .doublewrap-container .right-col p,
  .doublewrap-container .right-col ul {
    text-indent: 0em;
  }
  
  .doublewrap-container .left-col ul,
  .doublewrap-container .right-col ul {
      list-style-position: inside;
      padding-left: 1.25rem;
  }

  .{{ $left_class }},
  .{{ $right_class }} {
    width: {{ $width }};
    height: {{ $height }};
    shape-image-threshold: 0.5;
    shape-margin: 1rem;
  }

  .left-col img.js-float-centre,
  .right-col img.js-float-centre {
    margin-top:   var(--float-top,0);
  }


  .{{ $left_class }} {
    float: right;
    shape-outside: url("{{ $left_image }}");
    margin-left: 1.25rem;
  }

  .{{ $right_class }} {
    float: left;
    shape-outside: url("{{ $right_image }}");
    margin-right: 1.25rem;
  }
  
  	.mobile-img {
	  display: none;
	}
  
  @media only screen and (max-width: 900px) {
    .{{ $left_class }},
    .{{ $right_class }} {
	    width: calc({{ $width }} / 2);
        height: calc({{ $height }} / 2);
	}
	
	.doublewrap-container {
		display: grid;
		grid-template-columns: 1fr;
		gap: 0;
		max-width: 100%;
		padding: {{ $padding }};
		margin: {{ $margin }};
	  }
	  
    .left-col img.js-float-centre,
    .right-col img.js-float-centre {
      display: none;
    }
	
	.mobile-img {
	  display: block;
	  margin: auto;
	  width: calc({{ $width }} * 2);
      height: {{ $height }};
	}
	
  .doublewrap-container .right-col p,
  .doublewrap-container .right-col ul {
    text-indent: 1em;
  }

  }
</style>

<div class="doublewrap-container">

  <div class="left-col">
    {{ with $left_image }}
      <img src="{{ . }}" class="{{ $left_class }} js-float-centre" alt="">
    {{ end }}
    <div class="left-col-content">
    {{ $left_content | markdownify }}
    </div>
  </div>
    {{ with $mobile_image }}
      <img src="{{ . }}" class="{{ $left_class }} mobile-img" alt="">
    {{ end }}
  <div class="right-col">
    {{ with $right_image }}
      <img src="{{ . }}" class="{{ $right_class }} js-float-centre" alt="">
    {{ end }}
    <div class="right-col-content">
    {{ $right_content | markdownify }}
    </div>
  </div>
</div>