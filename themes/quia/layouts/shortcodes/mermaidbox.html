{{/* ────────────────────────────────────────────────────────────────
   Mermaid diagram box  •  v1.1
   Params (all inherited from mediabox + mermaid-specific):
     — data params:  title, caption, source, align, width, layout,
                     border, titleUnderline, greyBg, reverse, clear,
                     mobileFull
     — config        = path to JSON under /data merged into
                       mermaid.initialize({ … })
     — marginBottom  = any CSS length → extra margin-bottom (optional)
   Usage:
     {{< mermaidbox title="Flow" align="center" width="60%" >}}
     sequenceDiagram
       A-->B: Hi!
     {{< /mermaidbox >}}
------------------------------------------------------------------*/}}

{{/* --- Grab the inline diagram source ---------------------------- */}}
{{ $diagram := trim .Inner "\n\r\t " }}
{{- if eq $diagram "" -}}
  {{ errorf "mermaidbox shortcode: diagram text must be provided between tags" }}
{{- end }}

{{/* --- Optional Mermaid init config ------------------------------ */}}
{{ $cfg := dict }}
{{ with .Get "config" }}
  {{ $parts := split (replace . "/" ".") "." }}
  {{ $j := site.Data }}
  {{ range $parts }}{{ $j = index $j . }}{{ end }}
  {{ if $j }}{{ $cfg = $j }}{{ end }}
{{ end }}

{{/* --- Parameter processing (mirrors Mediabox) ------------------- */}}
{{ $type          := "diagram" }}
{{ $align         := .Get "align"         | default "right" }}
{{ $width         := .Get "width"         | default "40%" }}
{{ $layout        := .Get "layout"        | default "editorial" }}
{{ $mobileFull    := ne (.Get "mobileFull") "false" }}
{{ $marginBottom  := .Get "marginBottom" }}

{{ $border         := ne (.Get "border")         "false" }}
{{ $titleUnderline := ne (.Get "titleUnderline") "false" }}
{{ $greyBg         := eq (.Get "greyBg")         "true"  }}
{{ $reverse        := eq (.Get "reverse")        "true"  }}

{{ $n := add 1 (or ($.Page.Scratch.Get "mediaboxcounter") 0) }}
{{ $.Page.Scratch.Set "mediaboxcounter" $n }}
{{ $id          := .Get "id"    | default (printf "box-%d" $n) }}
{{ $title_text  := .Get "title" | default (printf "Diagram %d" $n) }}
{{ $diagramId   := printf "%s-diagram" $id }}

{{ $class := printf "mediabox mediabox-%s mediabox-layout-%s align-%s %s" $type $layout $align (.Get "class") }}
{{ if not $border }}         {{ $class = printf "%s mediabox-no-border"          $class }}{{ end }}
{{ if not $titleUnderline }} {{ $class = printf "%s mediabox-no-title-underline" $class }}{{ end }}
{{ if $greyBg }}             {{ $class = printf "%s mediabox-grey-background"    $class }}{{ end }}
{{ if $reverse }}            {{ $class = printf "%s mediabox-reverse"            $class }}{{ end }}
{{ if $mobileFull }}         {{ $class = printf "%s mediabox-mobile-full"        $class }}{{ end }}

{{/* --- Content & chrome ----------------------------------------- */}}
{{ $titlePart := printf `<figcaption class="mediabox-title">%s</figcaption>` $title_text }}

{{ $contentPart := printf `<div class="mediabox-content"><div id="%s" class="mermaid">%s</div></div>` $diagramId ($diagram | safeHTML) }}

{{ $captionPart := "" }}
{{ with .Get "caption" }}
  {{ $captionPart = printf `<figcaption class="mediabox-caption">%s</figcaption>` (. | markdownify) }}
{{ end }}

{{/* ---------- citation handling ---------- */}}
{{/* grab params (if any) */}}
{{ $citeRef    := .Get "cite" }}
{{ $citeStyle  := .Get "citeStyle" | default "text" | lower }}
{{ $overrideMD := .Get "citeOverride" }}

{{/* if citeOverride is supplied, use it verbatim */}}
{{ $citePart := "" }}
{{ with $overrideMD }}
  {{ $sourceHTML := . | markdownify }}
  {{ $sourceHTML = replace $sourceHTML `<a href` `<a target="_blank" rel="noopener" href` }}
  {{ $citePart = printf `<div class="mediabox-citation">%s</div>` $sourceHTML }}
{{ end }}

{{/* otherwise, look up the citation map by key and run the formatter */}}
{{ if and (eq $citePart "") $citeRef }}
  {{ $cites := $.Page.Params.citations }}
  {{ $entry := index $cites $citeRef }}
  {{ if $entry }}
    {{ $rendered := partial "citation.html" (dict "cite" $entry "style" $citeStyle) }}
    {{ $citePart = printf `<div class="mediabox-citation">%s</div>` $rendered }}
  {{ else }}
    {{ $citePart = printf `<div class=\"mediabox-citation\">[missing citation: %s]</div>` $citeRef }}
  {{ end }}
{{ end }}

{{/* --- Inline style string -------------------------------------- */}}
{{ $style := printf "max-width:%s;min-width:%s;" $width $width }}

{{/* Add padding-bottom when neither caption nor source exist */}}
{{ if and (eq $captionPart "") (eq $citePart "") }}
  {{ $style = printf "%spadding-bottom:0.5em;" $style }}
{{ end }}

{{/* Optional extra bottom margin */}}
{{ with $marginBottom }}
  {{ $style = printf "%s margin-bottom:%s;" $style . }}
{{ end }}

{{/* --- Render ---------------------------------------------------- */}}
{{ if eq (.Get "clear") "true" }}<div style="clear:both;"></div>{{ end }}
<figure id="{{ $id }}"
        class="{{ $class | safeHTMLAttr }}"
        style="{{ $style | safeCSS }}">
  {{ if eq $layout "top-banner" }}
    {{ $titlePart   | safeHTML }}
    {{ $captionPart | safeHTML }}
    {{ $contentPart | safeHTML }}
    {{ $citePart  | safeHTML }}
  {{ else if eq $layout "bottom-banner" }}
    {{ $contentPart | safeHTML }}
    {{ $titlePart   | safeHTML }}
    {{ $captionPart | safeHTML }}
    {{ $citePart  | safeHTML }}
  {{ else if eq $layout "right-sidecar" }}
    {{ $contentPart | safeHTML }}
    <div class="mediabox-text-wrapper">
      {{ $titlePart   | safeHTML }}
      {{ $captionPart | safeHTML }}
      {{ $citePart  | safeHTML }}
    </div>
  {{ else if eq $layout "left-sidecar" }}
    <div class="mediabox-text-wrapper">
      {{ $titlePart   | safeHTML }}
      {{ $captionPart | safeHTML }}
      {{ $citePart  | safeHTML }}
    </div>
    {{ $contentPart | safeHTML }}
  {{ else }}
    {{ $titlePart   | safeHTML }}
    {{ $contentPart | safeHTML }}
    {{ $captionPart | safeHTML }}
    {{ $citePart  | safeHTML }}
  {{ end }}
</figure>

{{/* --- Inline bootstrap (one per diagram) ------------------------ */}}
<script>
(() => {
  if (typeof mermaid === 'undefined') return;                    // Mermaid must be loaded globally
  const el = document.getElementById("{{ $diagramId }}");

  const cfgRaw = {{ $cfg | jsonify | safeJS }};
  const cfg = (typeof cfgRaw === 'string') ? JSON.parse(cfgRaw) : cfgRaw;
  mermaid.initialize(Object.assign({ startOnLoad: false }, cfg));

  mermaid.init(undefined, el);                                   // render just this diagram
})();
</script>
